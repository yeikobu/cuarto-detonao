---
import Layout from "../layouts/Layout.astro";
---

<Layout title="Resumen de tu reserva">
    <main class="flex flex-col w-full justify-center items-center text-center px-4 pt-20 space-y-10">
        <h2 class="text-3xl font-semibold">Resumen de tu reserva</h2>

        <!-- Sección de resumen del remitente -->
        <section id="sender-summary" class="flex flex-col items-start justify-center w-full max-w-lg px-5 py-5 border-2 border-gray-300 rounded-lg space-y-3">
            <h3 class="text-xl font-semibold">Datos del remitente</h3>
            <p><strong>Nombre:</strong> <span id="sender-name"></span></p>
            <p><strong>Apellido:</strong> <span id="sender-lastname"></span></p>
            <p><strong>Pseudónimo:</strong> <span id="sender-nickname"></span></p>
            <p><strong>Curso:</strong> <span id="sender-course"></span></p>
            <p><strong>Enviar como anónimo:</strong> <span id="sender-anonymous"></span></p>
        </section>

        <!-- Sección de resumen del destinatario -->
        <section id="recipient-summary" class="flex flex-col items-start justify-center w-full max-w-lg px-5 py-5 border-2 border-gray-300 rounded-lg space-y-3">
            <h3 class="text-xl font-semibold">Datos del destinatario</h3>
            <p><strong>Nombre:</strong> <span id="recipient-name"></span></p>
            <p><strong>Apellido:</strong> <span id="recipient-lastname"></span></p>
            <p><strong>Pseudónimo:</strong> <span id="recipient-nickname"></span></p>
            <p><strong>Curso:</strong> <span id="recipient-course"></span></p>
        </section>

        <!-- Sección de resumen de los items del carrito -->
        <section id="cart-summary" class="flex flex-col items-start justify-center w-full max-w-lg px-5 py-5 border-2 border-gray-300 rounded-lg space-y-3">
            <h3 class="text-xl font-semibold">Resumen de las rosas</h3>
            <div id="cart-items" class="w-full space-y-3"></div>
        </section>

        <!-- Botón para finalizar y reservar -->
        <button id="finalize-button" class="bg-gradient-to-r from-purple-800 via-purple-700 to-purple-600 text-white font-bold py-3 px-5 rounded-lg">
            Finalizar y reservar
        </button>
    </main>

    <script>
        import { formData, clearFormData } from "../stores/formStore";
        import { cartItems, clearCart } from "../stores/cartStore";

        const senderName = document.getElementById('sender-name') as HTMLParagraphElement;
        const senderLastname = document.getElementById('sender-lastname') as HTMLParagraphElement;
        const senderNickname = document.getElementById('sender-nickname') as HTMLParagraphElement;
        const senderCourse = document.getElementById('sender-course') as HTMLParagraphElement;
        const senderAnonymous = document.getElementById('sender-anonymous') as HTMLParagraphElement;
        const recipientName = document.getElementById('recipient-name') as HTMLParagraphElement;
        const recipientLastname = document.getElementById('recipient-lastname') as HTMLParagraphElement;
        const recipientNickname = document.getElementById('recipient-nickname') as HTMLParagraphElement;
        const recipientCourse = document.getElementById('recipient-course') as HTMLParagraphElement;


        // Función para renderizar los datos del formulario en el DOM
        function renderFormData() {
            const formState = formData.get();
            senderName.textContent = formState.sender.name || 'No especificado';
            senderLastname.textContent = formState.sender.lastname || 'No especificado';
            senderNickname.textContent = formState.sender.nickname || 'No especificado';
            senderCourse.textContent = formState.sender.course || 'No especificado';
            senderAnonymous.textContent = formState.sender.anonymous ? 'Sí' : 'No';
            
            recipientName.textContent = formState.recipient.name || 'No especificado';
            recipientLastname.textContent = formState.recipient.lastname || 'No especificado';
            recipientNickname.textContent = formState.recipient.nickname || 'No especificado';
            recipientCourse.textContent = formState.recipient.course || 'No especificado';
        }

        // Función para renderizar los items del carrito en el DOM
        function renderCartItems() {
            const cartState = cartItems.get();
            const cartItemsContainer = document.getElementById('cart-items') as HTMLDivElement;
            cartItemsContainer.innerHTML = ''; // Limpiar el contenedor

            if (cartState.length > 0) {
                cartState.forEach(item => {
                    const itemElement = document.createElement('div');
                    itemElement.innerHTML = `
                        <div class="flex flex-row items-center justify-between w-full"> 
                            <p>${item.title == "Rosa con dedicatoria" ? "" : item.title}</p>
                            <p>${item.title == "Rosa con dedicatoria" ? "" :item.quantity}</p>
                        </div>
                        <div class="flex flex-col items-start justify-between w-full"> 
                            ${item.message ? `<strong>Dedicatoria:</strong> <p>${item.message}</p>` : ''}
                        </div>
                        <div class="flex flex-col items-center justify-center w-full "> 
                            ${item.photo ? `<img src="${item.photo}" alt="Foto seleccionada" class="w-32 h-32 object-cover rounded-lg" />` : ''}
                        </div>
                    `;
                    cartItemsContainer.appendChild(itemElement);
                });
            } else {
                cartItemsContainer.textContent = 'No tienes rosas reservadas.';
            }
        }

        // Renderizar los datos del formulario y el carrito al cargar la página
        renderFormData();
        renderCartItems();

        // Finalizar y limpiar los datos
        const finalizeButton = document.getElementById('finalize-button') as HTMLButtonElement;
        finalizeButton.addEventListener('click', () => {
            clearCart();
            clearFormData();
            alert('Tu reserva ha sido finalizada.');
            window.location.reload(); // Recargar la página para actualizar el estado
        });
    </script>
</Layout>
