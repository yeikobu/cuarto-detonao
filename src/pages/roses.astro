---
import Layout from "../layouts/Layout.astro"
import SectionContainer from "../components/SectionContainer.astro"
import Plus from "../components/icons/Plus.astro"
import Minus from "../components/icons/Minus.astro"
import ChevronRigth from "../components/icons/ChevronRigth.astro"

import { roses } from "../data/roses"
---

<Layout title="Elige tus rosas">
    <main class="flex flex-col w-full justify-center items-center text-center px-4 pt-20 space-y-10">
        <SectionContainer>
            <h2 class="text-3xl font-semibold">Elige las rosas que quieres enviar a esa persona especial</h2>
            <div class="text-xs text-stone-400 flex flex-col items-start justify-center"> 
                <p>1 rosa x $2.000</p>
                <p>3 rosas x $5.000</p>
            </div>

            <div class="grid md:grid-cols-3 grid-cols-2 gap-x-4 gap-y-10 text-balance">
                {
                    roses.map(({ title, description, img }) => (
                        <div class="md:w-52 w-44 md:h-72 h-64 flex flex-col items-center justify-start space-y-2 text-pretty bg-neutral-950/80 hover:bg-neutral-900/90 rounded-2xl touch-manipulation">
                            <img src={img} alt={title} class="md:w-52 w-44 min-h-32 md:min-h-36 object-cover rounded-2xl"/>
                            <div class="flex flex-col justify-between h-full touch-manipulation">
                                <div class="space-y-1  touch-manipulation">
                                    <p class="text-sm font-semibold">{title}</p>
                                    <p class="text-xs">{description}</p>
                                </div>

                                <!-- Botones de aumentar y decrementar cantidad de rosas -->
                                <div class="flex flex-row items-center justify-center space-x-2 text-center pb-3 touch-manipulation">
                                    <button id={`btn-minus-${title}`} class="bg-purple-600/30 rounded-md p-1 touch-manipulation"> <Minus class="size-4 text-xl font-black"/> </button>
                                    <input type="text" placeholder="0" disabled id={`input-${title}`} class="w-12 px-4 rounded-lg text-center"/>
                                    <button id={`btn-plus-${title}`} class="bg-purple-600/30 rounded-md p-1 touch-manipulation"> <Plus class="size-4 text-xl font-black"/> </button>
                                </div>
                            </div>
                        </div>
                    ))
                }
            </div>
        </SectionContainer>

        <!-- Bottom sheet para mostrar un resumen y los botones de continuar con o sin foto -->
        <section id="bottom-sheet" class="md:w-3/5 w-full sticky bottom-5 flex flex-col justify-center gap-y-10 p-4 rounded-3xl bg-neutral-950/70 backdrop-blur-lg shadow-xl shadow-black ease-out transition-all translate-y-24 opacity-0 ">
            <div class="flex flex-row items-center justify-between">
                <div class="text-xs text-stone-400 flex flex-col items-start justify-center"> 
                    <p>1 rosa x $2000</p>
                    <p>3 rosas x $5000</p>
                </div>
                <div class="flex flex-col items-end justify-end gap-2">
                    <p class="text-xs font-semibold">Rosas seleccionadas: <span id="total-roses"></span></p>
                    <p class="font-bold">Total: $<span id="total-to-pay"></span></p>
                </div>
            </div>

            <div class="flex justify-around items-center">
                <div id="button-without-foto">
                    <button><a href="/data" class="bg-gradient-to-r from-purple-800 via-purple-700 to-purple-600 text-transparent bg-clip-text font-bold">Sin foto</a></button>
                </div>
                <div>
                    <button><a href="/photo" class="flex items-center justify-center py-3 px-5 bg-gradient-to-r from-purple-950 via-purple-900 to-purple-950 rounded-xl font-bold">Agregar foto<ChevronRigth class="size-6"/></a></button>
                </div>
            </div>
        </section>
    </main>
</Layout>

<script>
    import { roses } from "../data/roses";
    import { addCartItem, cartItems, updateCart } from "../stores/cartStore";

    // Esperar a que el DOM esté completamente cargado
    document.addEventListener("DOMContentLoaded", () => {
        // Obtener los elementos HTML necesarios
        const btnNext = document.getElementById("bottom-sheet") as HTMLElement;
        const totalOfRoses = document.getElementById("total-roses") as HTMLElement;
        const totalToPayElement = document.getElementById("total-to-pay") as HTMLElement;
        const buttonWithoutFoto = document.getElementById('button-without-foto') as HTMLButtonElement;

        // Cargar el carrito inicial desde la tienda global
        const currentCart = cartItems.get();

        buttonWithoutFoto.addEventListener('click', () => { 
            updateCart(currentCart)
        });
        
        // Sincronizar la UI con los datos del carrito almacenado en el estado global
        currentCart.forEach(item => {
            const input = document.getElementById(`input-${item.title}`) as HTMLInputElement;
            if (input) {
                input.value = item.quantity.toString();
                updatePedido(item.title, item.quantity); // Actualizamos los pedidos con los datos almacenados
            }
        });

        // Función para comprobar si los inputs tienen valores distintos de "0" o vacíos
        function checkInputs() {
            let showButton = false;
            
            roses.forEach(({ title }) => {
                const input = document.getElementById(`input-${title}`) as HTMLInputElement;
                if (input && input.value !== "" && input.value !== "0") {
                    showButton = true; 
                }
            });

            if (showButton) {
                btnNext.classList.remove("opacity-0");
                btnNext.classList.remove("translate-y-24");
                btnNext.classList.add("translate-y-0");
            } else {
                btnNext.classList.remove("translate-y-0");
                btnNext.classList.add("translate-y-24");
                btnNext.classList.add("opacity-0");
            }
        }

        // Función para actualizar el pedido y la cantidad en el carrito global
        function updatePedido(title: string, quantity: number) {
            addCartItem({ title, quantity }); // Actualiza el carrito global y guarda en Local Storage
            calculateTotal(); // Recalcular el total después de actualizar el carrito
        }

        // Función para calcular el total de rosas seleccionadas y el total a pagar
        function calculateTotal() {
            // Obtenemos el carrito desde la tienda global
            const currentCart = cartItems.get();
            const filteredCart = currentCart.filter(item => item.title !== "Rosa con dedicatoria");

            // Calculamos el total de rosas seleccionadas
            const totalRoses = filteredCart.reduce((acc, pedido) => acc + pedido.quantity, 0);
            let totalToPay = 0;

            if (totalRoses >= 3) {
                // Dividir el total de rosas en lotes de 3
                const fullSetsOfThree = Math.floor(totalRoses / 3); 
                const remainingRoses = totalRoses % 3; 
                
                // 5000 por cada conjunto de 3 rosas
                totalToPay = fullSetsOfThree * 5000;
                
                // 2000 por cada rosa adicional fuera del múltiplo de 3
                totalToPay += remainingRoses * 2000;
            } else {
                // Si el usuario ha seleccionado menos de 3 rosas, aplicar precio normal
                totalToPay = totalRoses * 2000;
            }

            // Actualizamos los valores en la UI
            totalOfRoses.innerHTML = totalRoses.toString();
            totalToPayElement.innerHTML = totalToPay.toString();
        }

        // Inicializamos los botones de incrementar/decrementar para cada rosa
        roses.forEach(({ title }) => {
            const btnPlus = document.getElementById(`btn-plus-${title}`) as HTMLButtonElement;
            const btnMinus = document.getElementById(`btn-minus-${title}`) as HTMLButtonElement;
            const input = document.getElementById(`input-${title}`) as HTMLInputElement;

            if (!btnPlus || !btnMinus || !input) return;

            // Buscar la cantidad inicial del carrito si está disponible
            const currentItem = currentCart.find(item => item.title === title);
            let quantity = currentItem ? currentItem.quantity : 0; // Inicializa con la cantidad del carrito o 0

            // Mostrar la cantidad inicial en el input
            input.value = quantity.toString();

            // Incrementar cantidad al hacer clic en "plus"
            btnPlus.addEventListener("click", () => {
                quantity++;
                input.value = quantity.toString();
                updatePedido(title, quantity); // Actualizamos el pedido y recalculamos el total
                checkInputs(); // Revisar si hay valores para mostrar el botón de "siguiente"
            });

            // Decrementar cantidad al hacer clic en "minus"
            btnMinus.addEventListener("click", () => {
                quantity--;
                if (quantity < 0) quantity = 0; // Asegurar que no haya valores negativos
                input.value = quantity.toString();
                updatePedido(title, quantity); // Actualizamos el pedido y recalculamos el total
                checkInputs(); // Revisar si hay valores para mostrar el botón de "siguiente"
            });
        });

        // Al cargar la página, oculta el botón "NextButton" si todos los inputs están vacíos o en "0"
        checkInputs();
    });
</script>
